<!DOCTYPE html>
<html>
<head>
    <title>Redaction Test</title>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #fff; padding: 20px; }
        .section { margin: 20px 0; padding: 20px; background: #2a2a2a; border-radius: 8px; }
        .redacted { background: #ff000030; }
        .visible { background: #00ff0030; }
        pre { white-space: pre-wrap; }
        button { padding: 10px; margin: 5px; background: #4a4a4a; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #5a5a5a; }
        input { padding: 5px; margin: 5px; background: #3a3a3a; color: white; border: 1px solid #555; }
    </style>
</head>
<body>
    <h1>Redaction Test Suite</h1>
    
    <div class="section">
        <h2>1. Upload Test File</h2>
        <input type="file" id="fileInput" accept=".txt,.log,.py,.js,.md">
        <button onclick="uploadFile()">Upload with Redaction</button>
        <div id="uploadResult"></div>
    </div>
    
    <div class="section">
        <h2>2. Check Redaction Settings</h2>
        <input type="text" id="shortCode" placeholder="Enter short code">
        <button onclick="checkRedaction()">Check Settings</button>
        <pre id="redactionSettings"></pre>
    </div>
    
    <div class="section">
        <h2>3. Preview File</h2>
        <button onclick="previewFile()">Preview</button>
        <pre id="previewContent"></pre>
    </div>

    <script>
        const API_BASE = 'http://localhost:8001/api/v1';
        let authToken = null;
        let currentShortCode = null;
        
        // Login first
        async function login() {
            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'username=test@example.com&password=testpassword'
            });
            const data = await response.json();
            authToken = data.access_token;
            console.log('Logged in:', authToken ? 'success' : 'failed');
        }
        
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }
            
            if (!authToken) await login();
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('expiry_minutes', '1440');
            formData.append('enable_preview_redaction', 'true');
            
            // Set line ranges (make lines 1-3 visible)
            formData.append('preview_line_start', '1');
            formData.append('preview_line_end', '3');
            
            // Set all ranges
            const redactionData = {
                lineRanges: [{ start: 1, end: 3 }],
                patterns: []
            };
            formData.append('preview_redaction_patterns', JSON.stringify(redactionData));
            
            try {
                const response = await fetch(`${API_BASE}/upload/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` },
                    body: formData
                });
                
                const data = await response.json();
                currentShortCode = data.short_code;
                document.getElementById('shortCode').value = currentShortCode;
                document.getElementById('uploadResult').innerHTML = `
                    <div style="color: #0f0;">
                        Upload successful!<br>
                        Short code: ${data.short_code}<br>
                        File: ${data.original_filename}
                    </div>
                `;
            } catch (error) {
                document.getElementById('uploadResult').innerHTML = `
                    <div style="color: #f00;">Error: ${error.message}</div>
                `;
            }
        }
        
        async function checkRedaction() {
            const shortCode = document.getElementById('shortCode').value;
            if (!shortCode) {
                alert('Please enter a short code');
                return;
            }
            
            if (!authToken) await login();
            
            try {
                const response = await fetch(`${API_BASE}/test/redaction/${shortCode}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                document.getElementById('redactionSettings').textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                document.getElementById('redactionSettings').textContent = `Error: ${error.message}`;
            }
        }
        
        async function previewFile() {
            const shortCode = document.getElementById('shortCode').value;
            if (!shortCode) {
                alert('Please enter a short code');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/download/${shortCode}/preview`);
                const headers = {};
                response.headers.forEach((value, key) => {
                    headers[key] = value;
                });
                
                const content = await response.text();
                
                document.getElementById('previewContent').innerHTML = `
                    <div style="margin-bottom: 10px; color: #ff0;">
                        Headers: ${JSON.stringify(headers, null, 2)}
                    </div>
                    <div style="border: 1px solid #555; padding: 10px;">
                        ${content.split('\n').map((line, i) => {
                            const isRedacted = line.includes('█') || line.includes('░') || line.includes('▒');
                            return `<div class="${isRedacted ? 'redacted' : 'visible'}">Line ${i+1}: ${line}</div>`;
                        }).join('')}
                    </div>
                `;
            } catch (error) {
                document.getElementById('previewContent').textContent = `Error: ${error.message}`;
            }
        }
        
        // Auto-login on load
        window.onload = login;
    </script>
</body>
</html>